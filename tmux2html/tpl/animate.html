<script>
window.tmux = new (function() {
  var data =
    $frame_bytes;
  var frame = 0;
  var frames = new Uint8Array(data.length / 2);
  var timerID = 0;

  for (var i = 0; i < data.length; i+=2) {
    frames[i / 2] = parseInt(data.substr(i, 2), 16);
  }
  frames = JSON.parse(pako.inflate(frames, {'to':'string'}));
  data = '';

  function nextDelay() {
    if (frames.length < 3) {
      return 0;
    }

    var f = frame;
    var g = 0;
    while (g < 4) {
      g++;
      var next = frames[f % frames.length];
      if (next.delay) {
        return next.delay;
      }
      f++;
    }
    return 0;
  }

  function nextFrame(no_advance) {
    var d = new Date();
    clearInterval(timerID);
    var fr = frames[frame % frames.length];
    frame++;
    if (fr.reset) {
      document.querySelector('.$prefix').innerHTML = fr.layout;
      return nextFrame(no_advance);
    }

    if (fr.lines) {
      for (var id in fr.lines) {
        var container = document.querySelector('#p' + id + ' > pre');
        if (!container.childNodes.length) {
          var html = '';
          for (var l in fr.lines[id]) {
            html += fr.lines[id][l];
          }
          container.innerHTML = html;
        } else {
          for (var l in fr.lines[id]) {
            container.childNodes[l].outerHTML = fr.lines[id][l];
          }
        }
      }
    }

    if (!!!no_advance && frames.length > 2) {
      var n = nextDelay();
      if (n) {
        var adj = (new Date()) - d;
        timerID = setTimeout(nextFrame, (n * 1000) - adj);
      }
    }
  }

  nextFrame();

  this.stop = function() {
    clearInterval(timerID);
  };

  this.resume = function() {
    nextFrame();
  };

  this.next = function() {
    this.stop();
    nextFrame(true);
  };
})();
</script>
